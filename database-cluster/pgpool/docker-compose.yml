version: "3.3"

services:
  pgpool:
    build:
      context: ./src
      dockerfile: Pgpool-latest.Dockerfile
    environment:
      PCP_USER: ${PCP_USER:-pcp_user}
      PCP_PASSWORD: ${PCP_USER:-pcp_pass}
      WAIT_BACKEND_TIMEOUT: 60

      CHECK_USER: ${CHECK_USER:-monkey_user}
      CHECK_PASSWORD: ${CHECK_PASSWORD:-monkey_pass}
      CHECK_PGCONNECT_TIMEOUT: 3 #timout for checking if primary node is healthy
      SSH_ENABLE: 1
      DB_USERS: ${DB_USERS:-monkey_user:monkey_pass} # in format user:password[,user:password[...]]
      BACKENDS: "0:pgmaster:5430:1::ALLOW_TO_FAILOVER,1:pgslave1:5433:::,3:pgslave3:5431:::,2:pgslave2:5434:::,4:pgslave4:5435:::" #,4:pgslaveDOES_NOT_EXIST::::
                # in format num:host:port:weight:data_directory:flag[,...]
                # defaults:
                #   port: 5432
                #   weight: 1
                #   data_directory: /var/lib/postgresql/data
                #   flag: ALLOW_TO_FAILOVER
      REQUIRE_MIN_BACKENDS: ${REQUIRED_MIN_BACKENDS:-2} # minimal number of backends to start pgpool (some might be unreachable)
      CONFIGS: "num_init_children:250,max_pool:4"
                # in format variable1:value1[,variable2:value2[,...]]
                # used for pgpool.conf file
    ports:
      - 5432:5432
      - 9898:9898 # PCP
    extra_hosts:
      - "pgmaster:${PGMASTER_ADDR}"
      - "pgslave1:${PGSLAVE1_ADDR}"
      - "pgslave2:${PGSLAVE2_ADDR}"
      - "pgslave3:${PGSLAVE1_ADDR}"
      - "pgslave4:${PGSLAVE2_ADDR}"
